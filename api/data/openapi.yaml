openapi: 3.0.3
info:
  title: Atomicbase API
  description: |
    REST API for SQLite/Turso with JSON queries, multi-tenant database management, and schema templates.

    ## Authentication
    If `ATOMICBASE_API_KEY` is set, all endpoints (except `/health`, `/docs`, `/openapi.yaml`) require a Bearer token:
    ```
    Authorization: Bearer <your-api-key>
    ```

    ## Multi-Tenant
    By default, requests target the primary SQLite database. To target a tenant database, use the `Tenant` header:
    ```
    Tenant: tenant-123
    ```

    ## Query Syntax

    All CRUD operations use JSON request bodies.

    ### Filtering
    The `where` field is always an array. Elements are ANDed together.

    **Operators:**
    - `{"column": {"eq": value}}` - Equal
    - `{"column": {"neq": value}}` - Not equal
    - `{"column": {"gt": value}}` - Greater than
    - `{"column": {"gte": value}}` - Greater than or equal
    - `{"column": {"lt": value}}` - Less than
    - `{"column": {"lte": value}}` - Less than or equal
    - `{"column": {"like": "%pattern%"}}` - SQL LIKE
    - `{"column": {"glob": "*pattern*"}}` - SQL GLOB
    - `{"column": {"in": [a, b, c]}}` - In list
    - `{"column": {"between": [min, max]}}` - Between values
    - `{"column": {"is": null}}` - IS NULL/TRUE/FALSE
    - `{"column": {"fts": "search terms"}}` - Full-text search
    - `{"column": {"not": {"eq": value}}}` - Negation wrapper

    **OR conditions:**
    ```json
    {"where": [{"org_id": {"eq": 5}}, {"or": [{"status": {"eq": "active"}}, {"role": {"eq": "admin"}}]}]}
    ```

    ### Nested Relations
    Auto-join via foreign keys:
    ```json
    {"select": ["id", "name", {"posts": ["title", {"comments": ["body"]}]}]}
    ```

  version: 1.0.0
  license:
    name: Apache-2.0

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Query
    description: CRUD operations on table rows
  - name: Batch
    description: Atomic batch operations
  - name: Schema
    description: Schema management operations
  - name: Tenants
    description: Tenant (database) management
  - name: Templates
    description: Schema template management

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      description: Returns the health status of the API and database connection.
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: unhealthy
                error: database ping failed

  /query/{table}:
    post:
      tags: [Query]
      summary: Query rows (SELECT, INSERT, UPSERT)
      description: |
        Perform SELECT, INSERT, or UPSERT operations based on the `Prefer` header.

        **SELECT** - `Prefer: operation=select`
        ```json
        {"select": ["id", "name"], "where": [{"status": {"eq": "active"}}], "limit": 20}
        ```

        **INSERT** - No Prefer header
        ```json
        {"data": {"name": "Alice"}, "returning": ["id"]}
        ```

        **UPSERT** - `Prefer: on-conflict=replace`
        ```json
        {"data": [{"id": 1, "name": "Alice"}], "returning": ["id"]}
        ```

        **INSERT IGNORE** - `Prefer: on-conflict=ignore`
        ```json
        {"data": {"id": 1, "name": "Alice"}}
        ```
      operationId: queryRows
      parameters:
        - $ref: '#/components/parameters/TablePath'
        - $ref: '#/components/parameters/TenantHeader'
        - name: Prefer
          in: header
          description: |
            Operation mode:
            - `operation=select` - SELECT query
            - `on-conflict=replace` - UPSERT
            - `on-conflict=ignore` - INSERT IGNORE
            - `count=exact` - Include total count in X-Total-Count header
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/SelectRequest'
                - $ref: '#/components/schemas/InsertRequest'
                - $ref: '#/components/schemas/UpsertRequest'
      responses:
        '200':
          description: Operation successful
          headers:
            X-Total-Count:
              description: Total row count (when Prefer count=exact is set)
              schema:
                type: integer
          content:
            application/json:
              schema:
                oneOf:
                  - type: array
                    items:
                      type: object
                  - $ref: '#/components/schemas/InsertResponse'
                  - $ref: '#/components/schemas/RowsAffectedResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    patch:
      tags: [Query]
      summary: Update rows
      description: |
        Update rows matching the WHERE conditions.

        ```json
        {"data": {"status": "inactive"}, "where": [{"id": {"eq": 5}}]}
        ```

        A WHERE clause is required.
      operationId: updateRows
      parameters:
        - $ref: '#/components/parameters/TablePath'
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRequest'
      responses:
        '200':
          description: Rows updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RowsAffectedResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    delete:
      tags: [Query]
      summary: Delete rows
      description: |
        Delete rows matching the WHERE conditions.

        ```json
        {"where": [{"id": {"eq": 5}}]}
        ```

        A WHERE clause is required.
      operationId: deleteRows
      parameters:
        - $ref: '#/components/parameters/TablePath'
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteRequest'
      responses:
        '200':
          description: Rows deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RowsAffectedResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /batch:
    post:
      tags: [Batch]
      summary: Execute batch operations
      description: |
        Execute multiple operations atomically in a single request. All operations succeed or all rollback.

        **Example:**
        ```json
        {
          "operations": [
            {"operation": "insert", "table": "users", "body": {"data": {"name": "Alice"}}},
            {"operation": "insert", "table": "users", "body": {"data": {"name": "Bob"}}},
            {"operation": "update", "table": "counters", "body": {"data": {"count": 2}, "where": [{"id": {"eq": 1}}]}}
          ]
        }
        ```

        **Supported operations:**
        - `select` - body: `{select, where, order, limit, offset}`
        - `insert` - body: `{data: {...}}`
        - `upsert` - body: `{data: [...]}`
        - `update` - body: `{data: {...}, where: [...]}`
        - `delete` - body: `{where: [...]}`
      operationId: batch
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchRequest'
            example:
              operations:
                - operation: insert
                  table: users
                  body:
                    data:
                      name: Alice
                - operation: insert
                  table: users
                  body:
                    data:
                      name: Bob
                - operation: select
                  table: users
                  body:
                    select: ["id", "name"]
      responses:
        '200':
          description: All operations succeeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchResponse'
              example:
                results:
                  - last_insert_id: 1
                  - last_insert_id: 2
                  - - id: 1
                      name: Alice
                    - id: 2
                      name: Bob
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /schema:
    get:
      tags: [Schema]
      summary: List all tables
      description: Get a list of all tables in the database schema.
      operationId: getSchema
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      responses:
        '200':
          description: List of tables
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Table'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /schema/invalidate:
    post:
      tags: [Schema]
      summary: Refresh schema cache
      description: Force a refresh of the schema cache.
      operationId: invalidateSchema
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      responses:
        '200':
          description: Schema cache invalidated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /schema/table/{table}:
    get:
      tags: [Schema]
      summary: Get table schema
      description: Get the schema definition for a specific table.
      operationId: getTableSchema
      parameters:
        - $ref: '#/components/parameters/TablePath'
        - $ref: '#/components/parameters/TenantHeader'
      responses:
        '200':
          description: Table schema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableSchemaResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    post:
      tags: [Schema]
      summary: Create table
      description: Create a new table with the specified columns.
      operationId: createTable
      parameters:
        - $ref: '#/components/parameters/TablePath'
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTableRequest'
      responses:
        '200':
          description: Table created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    patch:
      tags: [Schema]
      summary: Alter table
      description: Modify an existing table structure.
      operationId: alterTable
      parameters:
        - $ref: '#/components/parameters/TablePath'
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlterTableRequest'
      responses:
        '200':
          description: Table altered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    delete:
      tags: [Schema]
      summary: Drop table
      description: Drop a table and all its data.
      operationId: dropTable
      parameters:
        - $ref: '#/components/parameters/TablePath'
        - $ref: '#/components/parameters/TenantHeader'
      responses:
        '200':
          description: Table dropped
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /schema/fts:
    get:
      tags: [Schema]
      summary: List FTS indexes
      description: List all tables with FTS5 indexes.
      operationId: listFTSIndexes
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      responses:
        '200':
          description: List of FTS indexes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FTSIndexInfo'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /schema/fts/{table}:
    post:
      tags: [Schema]
      summary: Create FTS index
      description: |
        Create an FTS5 full-text search index on a table.

        After creating, use the `fts` operator in queries:
        ```json
        {"where": [{"title": {"fts": "search terms"}}]}
        ```
      operationId: createFTSIndex
      parameters:
        - $ref: '#/components/parameters/TablePath'
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFTSIndexRequest'
      responses:
        '200':
          description: FTS index created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    delete:
      tags: [Schema]
      summary: Drop FTS index
      description: Remove an FTS5 index from a table.
      operationId: dropFTSIndex
      parameters:
        - $ref: '#/components/parameters/TablePath'
        - $ref: '#/components/parameters/TenantHeader'
      responses:
        '200':
          description: FTS index dropped
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /tenants:
    get:
      tags: [Tenants]
      summary: List tenants
      description: List all registered tenant databases.
      operationId: listTenants
      responses:
        '200':
          description: List of tenants
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TenantInfo'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    post:
      tags: [Tenants]
      summary: Create tenant
      description: Create a new Turso database for a tenant.
      operationId: createTenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTenantRequest'
      responses:
        '200':
          description: Tenant created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    patch:
      tags: [Tenants]
      summary: Register existing tenant
      description: Register an existing Turso database as a tenant.
      operationId: registerTenant
      parameters:
        - name: DB-Token
          in: header
          description: Optional database authentication token
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterTenantRequest'
      responses:
        '200':
          description: Tenant registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /tenants/all:
    patch:
      tags: [Tenants]
      summary: Register all tenants
      description: Discover and register all Turso databases in your organization.
      operationId: registerAllTenants
      responses:
        '200':
          description: All tenants registered
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /tenants/{name}:
    delete:
      tags: [Tenants]
      summary: Delete tenant
      description: Delete a tenant database from Turso.
      operationId: deleteTenant
      parameters:
        - $ref: '#/components/parameters/NamePath'
      responses:
        '200':
          description: Tenant deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /tenants/{name}/template:
    get:
      tags: [Tenants]
      summary: Get tenant's template
      description: Get the schema template associated with a tenant.
      operationId: getTenantTemplate
      parameters:
        - $ref: '#/components/parameters/NamePath'
      responses:
        '200':
          description: Template info (or null if none)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    put:
      tags: [Tenants]
      summary: Associate template with tenant
      description: Associate a schema template with a tenant.
      operationId: setTenantTemplate
      parameters:
        - $ref: '#/components/parameters/NamePath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [templateName]
              properties:
                templateName:
                  type: string
      responses:
        '200':
          description: Template associated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    delete:
      tags: [Tenants]
      summary: Remove template association
      description: Remove the schema template association from a tenant.
      operationId: removeTenantTemplate
      parameters:
        - $ref: '#/components/parameters/NamePath'
      responses:
        '200':
          description: Template disassociated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /tenants/{name}/sync:
    post:
      tags: [Tenants]
      summary: Sync tenant to template
      description: Sync a tenant's schema to its associated template.
      operationId: syncTenantToTemplate
      parameters:
        - $ref: '#/components/parameters/NamePath'
        - name: dropExtra
          in: query
          description: Drop tables not in template
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Sync result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /templates:
    get:
      tags: [Templates]
      summary: List templates
      description: List all schema templates.
      operationId: listTemplates
      responses:
        '200':
          description: List of templates
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TemplateInfo'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    post:
      tags: [Templates]
      summary: Create template
      description: Create a new schema template.
      operationId: createTemplate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTemplateRequest'
      responses:
        '200':
          description: Template created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /templates/{name}:
    get:
      tags: [Templates]
      summary: Get template
      description: Get a schema template by name.
      operationId: getTemplate
      parameters:
        - $ref: '#/components/parameters/NamePath'
      responses:
        '200':
          description: Template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    put:
      tags: [Templates]
      summary: Update template
      description: Update a schema template's tables.
      operationId: updateTemplate
      parameters:
        - $ref: '#/components/parameters/NamePath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [tables]
              properties:
                tables:
                  type: array
                  items:
                    $ref: '#/components/schemas/Table'
      responses:
        '200':
          description: Template updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

    delete:
      tags: [Templates]
      summary: Delete template
      description: Delete a schema template.
      operationId: deleteTemplate
      parameters:
        - $ref: '#/components/parameters/NamePath'
      responses:
        '200':
          description: Template deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Template is in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /templates/{name}/sync:
    post:
      tags: [Templates]
      summary: Sync all tenants to template
      description: Sync all tenants using this template to the template schema.
      operationId: syncTemplate
      parameters:
        - $ref: '#/components/parameters/NamePath'
        - name: dropExtra
          in: query
          description: Drop tables not in template
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Sync results for all tenants
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TenantSyncResult'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

  /templates/{name}/databases:
    get:
      tags: [Templates]
      summary: List tenants using template
      description: List all tenants associated with a template.
      operationId: listTemplateTenants
      parameters:
        - $ref: '#/components/parameters/NamePath'
      responses:
        '200':
          description: List of tenant names
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
      security:
        - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: API key authentication. Set `ATOMICBASE_API_KEY` to enable.

  parameters:
    TablePath:
      name: table
      in: path
      required: true
      description: Table name
      schema:
        type: string
        pattern: '^[a-zA-Z_][a-zA-Z0-9_]*$'

    NamePath:
      name: name
      in: path
      required: true
      description: Resource name
      schema:
        type: string

    TenantHeader:
      name: Tenant
      in: header
      description: Target tenant database (default is primary)
      schema:
        type: string

  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string

    MessageResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string

    HealthResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
        error:
          type: string

    InsertResponse:
      type: object
      properties:
        last_insert_id:
          type: integer

    RowsAffectedResponse:
      type: object
      properties:
        rows_affected:
          type: integer

    SelectRequest:
      type: object
      properties:
        select:
          type: array
          items: {}
          description: Columns to select (strings or nested relation objects)
        where:
          type: array
          items:
            type: object
          description: Filter conditions (ANDed)
        order:
          type: object
          additionalProperties:
            type: string
            enum: [asc, desc]
          description: Order by columns
        limit:
          type: integer
        offset:
          type: integer

    InsertRequest:
      type: object
      required: [data]
      properties:
        data:
          type: object
          description: Row data to insert
        returning:
          type: array
          items:
            type: string
          description: Columns to return

    UpsertRequest:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            type: object
          description: Rows to upsert
        returning:
          type: array
          items:
            type: string

    UpdateRequest:
      type: object
      required: [data, where]
      properties:
        data:
          type: object
          description: Column values to update
        where:
          type: array
          items:
            type: object
          description: Filter conditions (required)

    DeleteRequest:
      type: object
      required: [where]
      properties:
        where:
          type: array
          items:
            type: object
          description: Filter conditions (required)

    BatchRequest:
      type: object
      required: [operations]
      properties:
        operations:
          type: array
          items:
            $ref: '#/components/schemas/BatchOperation'
          description: List of operations to execute atomically

    BatchOperation:
      type: object
      required: [operation, table, body]
      properties:
        operation:
          type: string
          enum: [select, insert, upsert, update, delete]
          description: Operation type
        table:
          type: string
          description: Target table name
        body:
          type: object
          description: Operation-specific body (same format as individual endpoints)

    BatchResponse:
      type: object
      required: [results]
      properties:
        results:
          type: array
          items: {}
          description: Results for each operation in order (arrays for select, objects for insert/update/delete)

    Table:
      type: object
      required: [name]
      properties:
        name:
          type: string
        pk:
          type: string
        columns:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/Column'

    Column:
      type: object
      required: [name, type]
      properties:
        name:
          type: string
        type:
          type: string
          enum: [TEXT, INTEGER, REAL, BLOB]
        notNull:
          type: boolean
        default: {}
        references:
          type: string
          description: "Foreign key (format: table.column)"

    TableSchemaResponse:
      type: object
      properties:
        columns:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              type:
                type: string
        primaryKey:
          type: string
        foreignKeys:
          type: array
          items:
            type: object
            properties:
              column:
                type: string
              references:
                type: string

    CreateTableRequest:
      type: object
      additionalProperties:
        type: object
        properties:
          type:
            type: string
            enum: [text, integer, real, blob]
          primaryKey:
            type: boolean
          unique:
            type: boolean
          notNull:
            type: boolean
          default: {}
          references:
            type: string
          onDelete:
            type: string
            enum: [no action, restrict, set null, set default, cascade]
          onUpdate:
            type: string
            enum: [no action, restrict, set null, set default, cascade]

    AlterTableRequest:
      type: object
      properties:
        newName:
          type: string
        renameColumns:
          type: object
          additionalProperties:
            type: string
        newColumns:
          type: object
          additionalProperties:
            type: object
        dropColumns:
          type: array
          items:
            type: string

    FTSIndexInfo:
      type: object
      properties:
        table:
          type: string
        ftsTable:
          type: string
        columns:
          type: array
          items:
            type: string

    CreateFTSIndexRequest:
      type: object
      required: [columns]
      properties:
        columns:
          type: array
          items:
            type: string
          minItems: 1

    TenantInfo:
      type: object
      properties:
        name:
          type: string
        id:
          type: integer

    CreateTenantRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        group:
          type: string
          default: default

    RegisterTenantRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string

    TemplateInfo:
      type: object
      properties:
        name:
          type: string

    Template:
      type: object
      properties:
        name:
          type: string
        tables:
          type: array
          items:
            $ref: '#/components/schemas/Table'

    CreateTemplateRequest:
      type: object
      required: [name, tables]
      properties:
        name:
          type: string
        tables:
          type: array
          items:
            $ref: '#/components/schemas/Table'

    SyncResponse:
      type: object
      properties:
        success:
          type: boolean
        changes:
          type: array
          items:
            type: string

    TenantSyncResult:
      type: object
      properties:
        database:
          type: string
        success:
          type: boolean
        changes:
          type: array
          items:
            type: string
        error:
          type: string

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    RateLimited:
      description: Rate limit exceeded
      headers:
        Retry-After:
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
